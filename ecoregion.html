<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ecoregion Lookup</title>

    <script src="scripts/config.js"></script>

    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

    <!-- Mapbox Search JS -->
    <script src="https://api.mapbox.com/search-js/v1.0.0-beta.17/web.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        #search-box {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            width: 300px;
        }
        
        .mapboxgl-popup-content {
            font: 14px/1.4 'Open Sans', sans-serif;
        }
    </style>
</head>

<body>
    <div id="search-box"></div>
    <div id="map"></div>

    <script>
        const SUPABASE_FUNCTION_URL =
            'https://czuldnytepaujjkjpwqi.functions.supabase.co/identify-location';

        mapboxgl.accessToken = MAPBOX_TOKEN;
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/ericschall/clvvt5o32098a01nucx668i03', // navigation
            center: [-103.59179687498357, 40.66995747013945],
            zoom: 3
        });

        // --- SEARCH BOX SETUP ---
        const searchBox = new MapboxSearchBox();
        searchBox.accessToken = mapboxgl.accessToken;
        document.getElementById('search-box').appendChild(searchBox);

        let marker = null;
        let popup = null;

        // --- HANDLE SEARCH SELECTION ---
        searchBox.addEventListener('retrieve', async(e) => {
            let feature = null;
            if (
                e &&
                e.detail &&
                e.detail.features &&
                e.detail.features.length > 0
            ) {
                feature = e.detail.features[0];
            }
            if (!feature) {
                console.warn('No valid location selected:', e);
                return;
            }

            const [lng, lat] = feature.geometry.coordinates;
            console.log('Selected:', lng, lat);

            // Place marker
            if (marker) marker.remove();
            marker = new mapboxgl.Marker({
                    color: '#FF5E00'
                })
                .setLngLat([lng, lat])
                .addTo(map);
            map.flyTo({
                center: [lng, lat],
                zoom: 8
            });

            // --- CALL SUPABASE FUNCTION ---
            try {
                const res = await fetch(SUPABASE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lng,
                        lat
                    })
                });
                const data = await res.json();
                console.log('Ecoregion result:', data);

                const eco = data.ecoregion;
                let text = 'No ecoregion found.';
                if (eco && eco.US_L3NAME) {
                    text = `<b>${eco.US_L3NAME}</b><br><small>Level III Code: ${eco.US_L3CODE}</small>`;
                }

                // --- SHOW POPUP ---
                if (popup) popup.remove();
                popup = new mapboxgl.Popup({
                        offset: 25
                    })
                    .setLngLat([lng, lat])
                    .setHTML(text)
                    .addTo(map);
            } catch (err) {
                console.error('Error calling function:', err);
            }
        });
    </script>
</body>

</html>