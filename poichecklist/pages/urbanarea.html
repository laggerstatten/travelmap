<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Identify Location + Local UAs + Routes</title>

    <script src="scripts/config.js"></script>
    <script src="scripts/drivetime_local.js"></script>
    <script src="scripts/drivetime_major.js"></script>
    <script src="scripts/drivetime.js"></script>

    <script src="scripts/buildUAPopup.js"></script>

    <!-- Mapbox -->
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

    <!-- Mapbox Search Box -->
    <script src="https://api.mapbox.com/search-js/v1.0.0-beta.17/web.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Open Sans', sans-serif;
        overflow: hidden;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
        z-index: 1;
      }

      #search-box {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        width: 320px;
      }
      /* Drawer styling */

      #result-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.97);
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.25);
        max-height: 50%;
        transform: translateY(60%);
        transition: transform 0.4s ease-in-out;
        overflow: auto;
        z-index: 20;
        padding: 10px;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
      }

      #result-panel.open {
        transform: translateY(0);
      }

      #result-toggle {
        position: absolute;
        top: 5px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        border-radius: 10px 10px 0 0;
        padding: 6px 16px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        user-select: none;
        z-index: 25;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.25);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        border-bottom: 1px solid #ccc;
        text-align: left;
        padding: 6px;
      }

      th {
        background-color: #f2f2f2;
      }

      tr:hover {
        background-color: #f0f8ff;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="search-box"></div>
    <div id="map"></div>

    <!-- Drawer -->
    <div id="result-panel">
      <div id="result-toggle">▲ Show Results</div>
      <h3>Local Urban Areas</h3>
      <table id="local-ua-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Population</th>
            <th>Drive Time (min)</th>
            <th>Distance (mi)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <h3>Major Urban Areas (within 500 mi)</h3>
      <table id="major-ua-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Population</th>
            <th>Drive Time (min)</th>
            <th>Distance (mi)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      mapboxgl.accessToken = MAPBOX_TOKEN;
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/ericschall/clvvt5o32098a01nucx668i03',
        center: [-103.59, 40.67],
        zoom: 3
      });

      const searchBox = new MapboxSearchBox();
      searchBox.accessToken = mapboxgl.accessToken;
      const searchContainer = document.getElementById('search-box');
      searchContainer.appendChild(searchBox);

      let marker = null;
      let popup = null;
      let originLng = null;
      let originLat = null;
      const routeLayerId = 'route-line';

      const resultPanel = document.getElementById('result-panel');
      const resultToggle = document.getElementById('result-toggle');

      resultToggle.addEventListener('click', function () {
        const isOpen = resultPanel.classList.contains('open');
        if (isOpen) {
          resultPanel.classList.remove('open');
          resultToggle.textContent = '▲ Show Results';
        } else {
          resultPanel.classList.add('open');
          resultToggle.textContent = '▼ Hide Results';
        }
      });

      function openDrawer() {
        const isOpen = resultPanel.classList.contains('open');
        if (!isOpen) {
          resultPanel.classList.add('open');
          resultToggle.textContent = '▼ Hide Results';
        }
      }

      function closeDrawer() {
        const isOpen = resultPanel.classList.contains('open');
        if (isOpen) {
          resultPanel.classList.remove('open');
          resultToggle.textContent = '▲ Show Results';
        }
      }

      // --- Search handler ---
      searchBox.addEventListener('retrieve', async function (e) {
        let feature = null;
        if (
          e &&
          e.detail &&
          e.detail.features &&
          e.detail.features.length > 0
        ) {
          feature = e.detail.features[0];
        }
        if (!feature) {
          console.warn('No valid location selected');
          return;
        }

        const coords = feature.geometry ? feature.geometry.coordinates : null;
        if (!coords || coords.length < 2) {
          console.warn('No coordinates found');
          return;
        }

        const lng = coords[0];
        const lat = coords[1];
        originLng = lng;
        originLat = lat;

        console.log('Selected:', lng, lat);

        if (marker) {
          marker.remove();
        }
        const newMarker = new mapboxgl.Marker({
          color: '#FF5E00'
        });
        newMarker.setLngLat([lng, lat]);
        newMarker.addTo(map);
        marker = newMarker;

        map.flyTo({
          center: [lng, lat],
          zoom: 8
        });

        // --- IDENTIFY LOCATION ---
        let info = null;
        try {
          const res = await fetch(SUPABASE_IDENTIFY_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              lng: lng,
              lat: lat
            })
          });
          info = await res.json();
        } catch (err) {
          console.error('Identify call failed:', err);
          return;
        }

        console.log('Location info:', info);

        // Clear tables at start of each search
        updateLocalUATable([]);
        updateMajorUATable([]);

        buildUAPopup(info, lng, lat);

        fetchLocalUA(info, lat, lng);
        fetchMajorUA(lat, lng);
      });
    </script>
  </body>
</html>
