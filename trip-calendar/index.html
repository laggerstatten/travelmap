<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Trip Calendar Prototype</title>
    <link rel="stylesheet" href="styles/base.css" />
    <link rel="stylesheet" href="styles/timeline.css" />
    <link rel="stylesheet" href="styles/forms.css" />

    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

    <!-- Mapbox Search Box -->
    <script src="https://api.mapbox.com/search-js/v1.0.0-beta.17/web.js"></script>
  </head>

  <body>
    <div id="toolbar">
      <button id="mode-timeline">Timeline</button>
      <button id="init-trip">Start Trip</button>
      <button id="add-stop">Add Segment</button>
      <button id="clear-auto">Clear Auto Drives</button>
      <button id="insert-drives">Insert Drives</button>
      <button id="gen-routes">Generate Routes</button>
      <button id="validate-btn">Validate & Repair</button>
      <button id="clear-unlocked-times">Clear Unlocked Times</button>
      <button id="clear-all-times">Clear All Times</button>
    </div>

    <div id="calendar" class="timeline"></div>

    <script>
      mapboxgl.accessToken =
        'pk.eyJ1IjoiZXJpY3NjaGFsbCIsImEiOiJjbDBsbmpvNHYwY3JhM2N0a2Ribm1rZ2k5In0.XY-ziSu8DLnv5UIstoSGRQ';
      MapboxSearchBox.accessToken = mapboxgl.accessToken;
      const TIMEZONE_TOKEN = '9QEU1A5823HR';
    </script>
    <!-- SEGMENT FUNCTIONS-->
    <script src="scripts/tripInit.js"></script>
    <script src="scripts/routing.js"></script>
    <script src="scripts/segmentcreator.js"></script>
    <script src="scripts/segmenteditor.js"></script>
    <script src="scripts/routevalidation.js"></script>

    <script src="scripts/timing.js"></script>
    <script src="scripts/slackOverlap.js"></script>

    <!-- UI FUNCTIONS-->
    <script src="scripts/timeline_ui.js"></script>
    <script src="scripts/timeline_card.js"></script>
    <script src="scripts/timeline_connector.js"></script>
    <script src="scripts/timeline_ehandling.js"></script>

    <!-- API FUNCTIONS-->
    <script src="scripts/good/externaldata.js"></script>

    <script>
      // Convert local time (entered in a specific timezone) → UTC ISO string
      function localToUTC(localDateTimeStr, timeZone) {
        // Parse as if it's in that timezone, then convert to UTC
        const [datePart, timePart] = localDateTimeStr.split('T');
        const [year, month, day] = datePart.split('-').map(Number);
        const [hour, minute] = timePart.split(':').map(Number);

        // Use Intl to find offset at that local time
        const fmt = new Intl.DateTimeFormat('en-US', {
          timeZone,
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        });
        const parts = fmt.formatToParts(
          new Date(Date.UTC(year, month - 1, day, hour, minute))
        );
        const utcGuess = Date.UTC(year, month - 1, day, hour, minute);

        // Calculate offset difference (in minutes) for that date in that zone
        const local = new Date(utcGuess);
        const tzOffset =
          local.getTimezoneOffset() - getTimezoneOffsetFor(timeZone, local);
        return new Date(utcGuess + tzOffset * 60 * 1000).toISOString();
      }

      function getTimezoneOffsetFor(timeZone, date) {
        const f = new Intl.DateTimeFormat('en-US', {
          timeZone,
          hour12: false,
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        const parts = f.formatToParts(date);
        const rebuilt = new Date(
          `${parts.find((p) => p.type === 'year').value}-${
            parts.find((p) => p.type === 'month').value
          }-${parts.find((p) => p.type === 'day').value}T${
            parts.find((p) => p.type === 'hour').value
          }:${parts.find((p) => p.type === 'minute').value}:00`
        );
        return (rebuilt - date) / 60000; // offset in minutes
      }

      // Convert stored UTC → local input string for display
      function utcToLocalInput(utcString, timeZone) {
        if (!utcString) return ''; // cleared field
        const d = new Date(utcString);
        if (isNaN(d)) return ''; // invalid date

        const parts = new Intl.DateTimeFormat('en-CA', {
          timeZone,
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        }).formatToParts(d);

        const map = Object.fromEntries(parts.map((p) => [p.type, p.value]));
        return `${map.year}-${map.month}-${map.day}T${map.hour}:${map.minute}`;
      }

      function fmtDate(dateStr, timeZone) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const opts = {
          timeZone: timeZone || 'UTC',
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          timeZoneName: 'short',
          hour12: true
        };
        return new Intl.DateTimeFormat('en-US', opts).format(d);
      }

      function dayStr(iso) {
        if (!iso) return '';
        return new Date(iso).toDateString();
      }

      function save(noRender = false) {
        computeSlackAndOverlap(segments);
        localStorage.setItem('tripSegments', JSON.stringify(segments));
        if (!noRender) renderTimeline();
      }

      function newId() {
        return crypto.randomUUID
          ? crypto.randomUUID()
          : Date.now() + Math.random().toString(36).slice(2);
      }

      function getElementById(id) {
        return segments.find((e) => String(e.id) === String(id));
      }

      /* ---------- State ---------- */
      let segments = JSON.parse(localStorage.getItem('tripSegments')) || [];

      // Toolbar actions
      document.getElementById('mode-timeline').onclick = () => {
        renderTimeline();
      };

      document.getElementById('init-trip').onclick = () => {
        initTrip(segments);
      };

      document.getElementById('add-stop').onclick = () => {
        queueStop(segments);
      };

      document.getElementById('clear-auto').onclick = () => {
        clearAutoDrives();
      };

      document.getElementById('insert-drives').onclick = () => {
        insertDriveSegments();
      };

      document.getElementById('gen-routes').onclick = () => {
        generateRoutes();
      };

      document.getElementById('validate-btn').onclick = async () => {
        await validateAndRepair();
      };

      document.getElementById('clear-unlocked-times').onclick = () => {
        clearTimesAndDurations({
          onlyUnlocked: true
        });
      };

      document.getElementById('clear-all-times').onclick = () => {
        clearTimesAndDurations();
      };

      // Initial render
      renderTimeline();
    </script>
  </body>
</html>
